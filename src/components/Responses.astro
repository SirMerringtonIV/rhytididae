---
import fs from 'fs';
import path from 'path';

const {
  file,              // JSON filename passed as prop
  responseCol = 9,   // J
  userCol = 4,       // E
  winnerCol = 10,    // F
  questionCol = 9    // J
} = Astro.props;

if (!file) throw new Error("You must provide a 'file' prop to Responses.astro");

// --- READ JSON AT BUILD TIME ---
const jsonPath = path.resolve('./public/data', file);
if (!fs.existsSync(jsonPath)) {
  throw new Error(`JSON file not found: ${jsonPath}`);
}
const rows = JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));

// Question (first row)
const question = rows?.[0]?.[questionCol] ? String(rows[0][questionCol]).trim() : '';

// Entries
const entries = rows
  .slice(1)
  .filter(r => r[responseCol] && r[userCol])
  .map(r => ({
    response: String(r[responseCol]).trim(),
    user: String(r[userCol]).trim(),
    isWinner: Boolean(r[winnerCol])
  }));

const winner = entries.find(e => e.isWinner);
const others = entries
  .filter(e => !e.isWinner)
  .sort((a, b) => a.user.localeCompare(b.user, undefined, { sensitivity: "base" }));
---

{question && (
  <p class="question">
    <strong>This week we asked our players:</strong> {question}
  </p>
)}

{winner && (
  <div class="winner">
    <h3>Winner, mascot for the week</h3>
    <blockquote>
      {winner.response}
      <br />
      -<cite>{winner.user}</cite>
    </blockquote>
  </div>
)}

{others.length > 0 && (
  <div class="responses">
    {others.map(e => (
      <blockquote>
        {e.response}
        <br />
        â€” <cite>{e.user}</cite>
      </blockquote>
    ))}
  </div>
)}

<style>
  blockquote {
    margin: 2rem 0; /* space between responses */
    padding-left: 1rem;
    border-left: 3px solid #ccc;
    font-style: italic;
  }

  cite {
    font-style: normal;
    font-weight: 600;
  }

  .winner blockquote {
    border-left-color: gold;
  }
  .question {
    margin-bottom: 2rem;
  }
</style>
