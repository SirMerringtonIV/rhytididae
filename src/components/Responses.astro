---
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const {
  file,              // JSON filename passed as prop, e.g., "starmantis.json"
  responseCol = 9,   // J
  userCol = 4,       // E
  winnerCol = 10,    // F
  questionCol = 9    // J
} = Astro.props;

if (!file) throw new Error("You must provide a 'file' prop to Responses.astro");

// --- RESOLVE PROJECT ROOT RELIABLY ---
const projectRoot = fileURLToPath(new URL('../../../../', import.meta.url));

// --- JSON PATH ---
const jsonPath = path.join(projectRoot, 'public', 'data', file);
if (!fs.existsSync(jsonPath)) {
  throw new Error(`JSON file not found: ${jsonPath}`);
}

// --- READ JSON ---
const rows = JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));

// --- EXTRACT QUESTION ---
const question = rows?.[0]?.[questionCol] ? String(rows[0][questionCol]).trim() : '';

// --- EXTRACT ENTRIES ---
const entries = rows
  .slice(1)
  .filter(r => r[responseCol] && r[userCol])
  .map(r => ({
    response: String(r[responseCol]).trim(),
    user: String(r[userCol]).trim(),
    isWinner: Boolean(r[winnerCol])
  }));

const winner = entries.find(e => e.isWinner);
const others = entries
  .filter(e => !e.isWinner)
  .sort((a, b) => a.user.localeCompare(b.user, undefined, { sensitivity: 'base' }));
---

{question && <h2>This week we asked our players: {question}</h2>}

{winner && <div><strong>Winner:</strong> {winner.user} â€” {winner.response}</div>}

{others.length > 0 && (
  <ul>
    {others.map(e => <li>{e.user}: {e.response}</li>)}
  </ul>
)}
