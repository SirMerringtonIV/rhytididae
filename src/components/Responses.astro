---
import path from "path";
import * as XLSX from "xlsx";
import fs from "fs";

const {
  file,              // path to .xlsx (relative to /src)
  responseCol = 9,   // J
  userCol = 4,       // E
  winnerCol = 10,    // F
  questionCol = 9    // J
} = Astro.props;

// Resolve file path relative to project root (server-side)
const filePath = path.resolve('./', file);

// Ensure file exists
if (!fs.existsSync(filePath)) {
  throw new Error(`Excel file not found: ${filePath}`);
}

// Read workbook and sheet (server-side)
const workbook = XLSX.readFile(filePath);
const sheet = workbook.Sheets[workbook.SheetNames[2]];
const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

// Extract question from the first row
const question = rows?.[0]?.[questionCol]
  ? String(rows[0][questionCol]).trim()
  : "";

// Process entries
const entries = rows
  .slice(1)
  .filter(r => r[responseCol] && r[userCol])
  .map(r => ({
    response: String(r[responseCol]).trim(),
    user: String(r[userCol]).trim(),
    isWinner: Boolean(r[winnerCol])
  }));

const winner = entries.find(e => e.isWinner);
const others = entries
  .filter(e => !e.isWinner)
  .sort((a, b) =>
    a.user.localeCompare(b.user, undefined, { sensitivity: "base" })
  );
---

<!-- Render the question -->
{question && <h2>This week we asked our players: {question}</h2>}

<!-- Render the winner -->
{winner && (
  <div>
    <strong>Winner:</strong> {winner.user} â€” {winner.response}
  </div>
)}

<!-- Render the other entries alphabetically -->
{others.length > 0 && (
  <ul>
    {others.map(e => (
      <li>{e.user}: {e.response}</li>
    ))}
  </ul>
)}

